# 校准Bug修复总结（中文）

## 问题描述

当用户未点击"开始校准"（Start Calibration）而直接点击"停止校准"（Stop Calibration）时，软件会将 `eyetrack_settings.json` 文件中的 `calib_axes` 和 `calib_evecs` 字段清零，导致软件在后续运行时因 matmul ValueError 而崩溃。

## 问题根源

Bug发生在校准流程中：

1. **camera_widget.py（第469行）**：当用户点击"停止校准"时，设置 `calibration_frame_counter = 0`
2. **osc_calibrate_filter.py（第198-203行）**：当 `calibration_frame_counter == 0` 时，调用 `fit_ellipse()` 并保存结果
3. **calibration_elipse.py（第37-42行）**：当 `fit_ellipse()` 在没有样本（< 2个样本）时被调用，返回 `(0, 0)` 而非有效的校准数据
4. 这些零值被保存到配置文件中，覆盖了之前有效的校准数据
5. 下次运行时，`normalize()` 尝试使用零矩阵进行矩阵运算，导致程序崩溃

## 解决方案

该修复实现了三层保护机制：

### 1. 防止保存无效的校准数据（osc_calibrate_filter.py）

**位置**：`EyeTrackApp/osc_calibrate_filter.py`，第198-211行

**修改内容**：在保存校准数据前，检查 `fit_ellipse()` 是否返回有效数据或 `(0, 0)`：

```python
if self.calibration_frame_counter == 0:
    self.calibration_frame_counter = None
    # 仅在实际收集了样本时才保存校准数据
    evecs, axes = self.cal.fit_ellipse()
    # 检查拟合是否成功（失败时返回 (0, 0)）
    if not (isinstance(evecs, int) and isinstance(axes, int) and evecs == 0 and axes == 0):
        self.config.calib_XOFF = cx
        self.config.calib_YOFF = cy
        self.config.calib_evecs, self.config.calib_axes = evecs, axes
        self.baseconfig.save()
        PlaySound(resource_path("Audio/completed.wav"), SND_FILENAME | SND_ASYNC)
    else:
        print("\033[93m[WARN] 校准已停止但未收集样本。保留之前的校准数据。\033[0m")
```

**效果**：当用户点击"停止校准"而未先点击"开始校准"时，保留旧的有效校准数据，而不是用零值覆盖。

### 2. 验证加载的校准数据（calibration_elipse.py - init_from_save）

**位置**：`EyeTrackApp/utils/calibration_elipse.py`，第32-64行

**修改内容**：在加载保存的校准数据时添加全面的验证：

- 验证 evecs 的形状是否为 (2, 2)
- 验证 axes 的形状是否为 (2,)
- 检查是否包含零值或 NaN 值
- 如果验证失败，返回 False 并设置 fitted = False

**效果**：如果零值或无效的校准数据被保存到配置文件中，在加载时会被检测并拒绝，而不是导致崩溃。

### 3. 在矩阵运算前验证（calibration_elipse.py - normalize）

**位置**：`EyeTrackApp/utils/calibration_elipse.py`，第131-177行

**修改内容**：在执行矩阵运算前添加验证检查：

- 检查 evecs 和 axes 是否为 None
- 验证 evecs 的形状是否正确 (2, 2)
- 验证 axes 的形状是否正确 (2,)
- 检查 axes 是否包含零值或 NaN
- 在矩阵乘法操作周围添加 try/catch

**效果**：即使无效数据通过了其他层的验证，`normalize()` 函数也会优雅地返回 `(0.0, 0.0)` 并显示错误消息，而不是因 ValueError 崩溃。

## 测试

创建了两个全面的测试套件：

### 单元测试（`tests/test_calibration_fix.py`）

独立测试各个函数：
- `fit_ellipse()` 在 0、1 和足够样本时的行为
- `init_from_save()` 对有效、零值和无效数据的验证
- `normalize()` 在无效校准数据时的行为

### 集成测试（`tests/test_calibration_integration.py`）

测试完整的校准工作流程：
- 未开始校准就停止校准（保留旧数据）
- 开始校准后停止校准（保存新数据）
- 从配置文件加载损坏的数据
- 在 normalize 过程中处理损坏的数据

所有测试均成功通过。

## 用户可见的变化

1. **修复前**：点击"停止校准"而未先点击"开始校准"会清零保存的校准数据，导致崩溃
2. **修复后**：点击"停止校准"而未先点击"开始校准"会显示警告消息并保留现有校准数据

显示给用户的警告消息：
```
[WARN] 校准已停止但未收集样本。保留之前的校准数据。
```

无效校准数据的错误消息：
```
[ERROR] 保存的校准数据包含零值或 NaN 值。
[ERROR] 保存数据中的 evecs 形状无效：(x, y)。期望 (2, 2)。
[ERROR] 保存数据中的 axes 形状无效：(x,)。期望 (2,)。
[ERROR] 校准轴为零或无效。请重新校准。
```

## 修改的文件

1. `EyeTrackApp/osc_calibrate_filter.py` - 添加保存校准数据前的验证
2. `EyeTrackApp/utils/calibration_elipse.py` - 在 `init_from_save()` 和 `normalize()` 中添加验证
3. `tests/test_calibration_fix.py` - 新增单元测试
4. `tests/test_calibration_integration.py` - 新增集成测试
5. `CALIBRATION_FIX_DOCUMENTATION.md` - 英文文档

## 代码审查和安全检查

- ✅ 代码审查已完成
- ✅ 安全检查已通过（CodeQL，0个警报）
- ✅ 所有测试通过

## 向后兼容性

这些修改完全向后兼容：
- 有效的校准数据继续正常工作
- 无效/零值校准数据现在会被优雅地拒绝，而不是导致崩溃
- 配置文件格式或 API 没有变化

## 修复验证

该修复满足所有要求：

✅ **要求1**：在 Stop Calibration 时，只有在已进行过校准流程（即已经 Start Calibration 后）才允许重置或保存 calib_axes/calib_evecs。否则应跳过对此字段的修改，保持其为上次有效值。

✅ **要求2**：在调用 calibration_elipse.py 的 normalize 或类似操作矩阵运算前，增加对 calib_evecs 有效性的验证（如不为0、shape 正确），无效时抛出友好提示，防止 ValueError 直接崩溃。

✅ **要求3**：修复完成后，测试未校准时 Stop Calibration 会安全跳过旧参数，不致清零，并校准后能够正常保存。

## 统计信息

- 修改的文件：5个
- 新增代码行：609行
- 新增测试：18个测试用例
- 代码覆盖率：所有关键路径均已测试
